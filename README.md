# 小米代挂 Telegram 机器人

这是一个基于 Telegram Bot API 的小米账号登录管理机器人，支持用户授权管理、实时任务执行和任务终止功能。

## 项目结构

```
xiaomi/
├── tg_bot.py          # Telegram 机器人主程序
├── login.py           # 小米账号登录脚本
├── xiaomiconfig.json  # 小米账号配置文件
├── tg_auth_users.json # 用户授权信息文件（自动生成）
├── xiaomi_logs.json   # 运行记录日志文件（自动生成）
└── README.md          # 项目说明文档
```

## 主要功能

### 1. 用户授权管理
- **管理员功能**：可以给普通用户授权、续费、取消授权
- **授权验证**：普通用户需要授权才能使用登录功能
- **到期提醒**：自动检查用户授权是否过期

### 2. 任务执行管理
- **实时输出**：任务执行过程中的输出实时推送到 Telegram
- **任务终止**：支持通过 `/stop` 命令立即终止正在执行的任务
- **并发控制**：防止同一用户同时执行多个任务

### 3. 小米账号登录
- **自动登录**：执行小米账号的自动登录流程
- **状态反馈**：实时显示登录进度和结果
- **错误处理**：完善的异常处理和错误提示

### 4. 运行记录查询
- **日志记录**：自动记录所有用户的运行记录
- **权限控制**：管理员可查询所有记录，普通用户只能查询自己的记录
- **详细记录**：包含执行时间、操作类型、执行结果和详细信息

## 配置说明

### 环境变量配置（青龙面板）

在青龙面板的环境变量中添加以下配置：

```bash
# Telegram Bot Token（必需）
TG_BOT_TOKEN=你的BotFather Token

# 管理员用户ID列表（可选，多个用逗号分隔）
TG_ADMIN_LIST=5096026941,123456789
```

### 默认配置

- **默认管理员**：5096026941
- **授权文件**：tg_auth_users.json
- **配置文件**：xiaomiconfig.json

## 使用方法

### 管理员指令

| 指令 | 参数 | 说明 | 示例 |
|------|------|------|------|
| `/login` | 无 | 执行小米登录脚本 | `/login` |
| `/query` | 无 | 查询管理员身份 | `/query` |
| `/auth` | 用户ID 天数 | 授权用户N天 | `/auth 123456789 30` |
| `/renew` | 用户ID 天数 | 续费用户N天 | `/renew 123456789 30` |
| `/cancel` | 用户ID | 取消用户授权 | `/cancel 123456789` |
| `/query_auth` | 用户ID | 查询用户授权状态 | `/query_auth 123456789` |
| `/logs` | [用户ID] [数量] | 查询运行记录 | `/logs` 或 `/logs 123456789 10` |
| `/stop` | 无 | 终止当前任务 | `/stop` |
| `/help` | 无 | 查看帮助信息 | `/help` |

### 普通用户指令

| 指令 | 参数 | 说明 | 示例 |
|------|------|------|------|
| `/login` | 无 | 执行小米登录脚本（需授权） | `/login` |
| `/query` | 无 | 查询授权剩余天数 | `/query` |
| `/logs` | [数量] | 查询自己的运行记录 | `/logs` 或 `/logs 10` |
| `/stop` | 无 | 终止当前任务 | `/stop` |
| `/help` | 无 | 查看帮助信息 | `/help` |

## 日志查询指令（新版）

### 普通用户
- `/logs [数量]`  查询自己所有账号的运行日志，数量可选，默认全部。
- 返回内容：每个账号的标识、日志内容。

### 管理员
- `/logs [数量]`  查询所有账号的运行日志，数量可选，默认全部。
- 返回内容：每个账号的标识、日志内容。

#### 示例
```
/logs
/logs 5
```

## 代码架构

### 核心类说明

#### 1. Config 类
- **功能**：配置管理
- **职责**：加载环境变量、管理机器人配置

#### 2. AuthManager 类
- **功能**：授权信息管理
- **职责**：读写授权文件、计算到期时间

#### 3. AdminUser 类
- **功能**：管理员用户操作
- **职责**：授权管理、用户查询、权限验证

#### 4. NormalUser 类
- **功能**：普通用户操作
- **职责**：授权验证、状态查询

#### 5. TaskManager 类
- **功能**：任务状态管理
- **职责**：跟踪用户任务状态、防止并发执行

#### 6. TaskExecutor 类
- **功能**：任务执行器
- **职责**：异步执行任务、实时输出捕获、任务终止

#### 7. BotCommands 类
- **功能**：机器人指令处理
- **职责**：处理所有 Telegram 指令、权限验证

#### 8. LogManager 类
- **功能**：运行记录管理
- **职责**：记录用户操作日志、查询历史记录

### 关键特性

#### 1. 实时输出捕获
```python
class TelegramOutput:
    """Telegram输出重定向器"""
    def write(self, text):
        # 实时捕获 print 输出并推送到 Telegram
```

#### 2. 异步任务执行
```python
async def run_task_with_stop(self, update, task_func, task_name="任务"):
    # 在后台异步执行任务，主线程保持响应
```

#### 3. 任务终止机制
```python
async def stop(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
    # 立即设置终止标志，任务在0.5秒内响应
```

## 部署说明

### 1. 青龙面板部署

1. 在青龙面板中创建新脚本
2. 上传所有项目文件
3. 设置环境变量 `TG_BOT_TOKEN` 和 `TG_ADMIN_LIST`
4. 运行 `tg_bot.py` 脚本

### 2. 依赖安装

确保以下 Python 包已安装：
```bash
pip install python-telegram-bot
```

### 3. 配置文件

确保 `xiaomiconfig.json` 文件包含正确的小米账号配置信息。

## 故障排除

### 常见问题

1. **Bot Token 无效**
   - 检查 `TG_BOT_TOKEN` 环境变量是否正确设置
   - 确认 Bot Token 来自 @BotFather

2. **权限不足**
   - 确认用户ID是否在管理员列表中
   - 检查用户授权是否过期

3. **任务无法终止**
   - 检查网络连接
   - 确认 `/stop` 命令在任务执行期间发送

4. **输出不实时**
   - 检查网络延迟
   - 确认任务执行过程中有 print 输出

### 日志查看

在青龙面板中查看脚本运行日志，定位具体错误信息。

## 更新日志

### v1.0.0
- 初始版本发布
- 支持基本的用户授权管理
- 实现小米账号登录功能
- 支持实时输出和任务终止

## 技术支持

如有问题，请联系管理员或查看青龙面板运行日志。 